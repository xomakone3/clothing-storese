import os
import logging
from dotenv import load_dotenv
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup, WebAppInfo
from telegram.ext import Updater, CommandHandler, CallbackQueryHandler, CallbackContext, MessageHandler, Filters

# –ó–∞–≥—Ä—É–∑–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
load_dotenv()

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    level=logging.INFO
)

# URL –≤–∞—à–µ–≥–æ –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (–∑–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–π URL –ø–æ—Å–ª–µ –¥–µ–ø–ª–æ—è)
WEBAPP_URL = "https://xomakone3.github.io/clothing-storese/"

# –ö–∞—Ç–∞–ª–æ–≥ —Ç–æ–≤–∞—Ä–æ–≤
PRODUCTS = {
    'tshirts': {
        'name': '–§—É—Ç–±–æ–ª–∫–∏',
        'items': [
            {'name': '–ë–∞–∑–æ–≤–∞—è –±–µ–ª–∞—è —Ñ—É—Ç–±–æ–ª–∫–∞', 'price': '1500‚ÇΩ', 'description': '–ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∞—è –±–µ–ª–∞—è —Ñ—É—Ç–±–æ–ª–∫–∞ –∏–∑ 100% —Ö–ª–æ–ø–∫–∞'},
            {'name': '–ß–µ—Ä–Ω–∞—è —Ñ—É—Ç–±–æ–ª–∫–∞ —Å –ø—Ä–∏–Ω—Ç–æ–º', 'price': '2000‚ÇΩ', 'description': '–°—Ç–∏–ª—å–Ω–∞—è —Ñ—É—Ç–±–æ–ª–∫–∞ —Å —É–Ω–∏–∫–∞–ª—å–Ω—ã–º –¥–∏–∑–∞–π–Ω–æ–º'},
        ]
    },
    'jackets': {
        'name': '–ö—É—Ä—Ç–∫–∏',
        'items': [
            {'name': '–î–∂–∏–Ω—Å–æ–≤–∞—è –∫—É—Ä—Ç–∫–∞', 'price': '5000‚ÇΩ', 'description': '–ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∞—è –¥–∂–∏–Ω—Å–æ–≤–∞—è –∫—É—Ä—Ç–∫–∞ —Å–∏–Ω–µ–≥–æ —Ü–≤–µ—Ç–∞'},
            {'name': '–ö–æ–∂–∞–Ω–∞—è –∫—É—Ä—Ç–∫–∞', 'price': '15000‚ÇΩ', 'description': '–°—Ç–∏–ª—å–Ω–∞—è –∫–æ–∂–∞–Ω–∞—è –∫—É—Ä—Ç–∫–∞ —á–µ—Ä–Ω–æ–≥–æ —Ü–≤–µ—Ç–∞'},
        ]
    },
    'pants': {
        'name': '–®—Ç–∞–Ω—ã',
        'items': [
            {'name': '–î–∂–∏–Ω—Å—ã –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–µ', 'price': '3500‚ÇΩ', 'description': '–°–∏–Ω–∏–µ –¥–∂–∏–Ω—Å—ã –ø—Ä—è–º–æ–≥–æ –∫—Ä–æ—è'},
            {'name': '–°–ø–æ—Ä—Ç–∏–≤–Ω—ã–µ —à—Ç–∞–Ω—ã', 'price': '2500‚ÇΩ', 'description': '–£–¥–æ–±–Ω—ã–µ —à—Ç–∞–Ω—ã –¥–ª—è —Å–ø–æ—Ä—Ç–∞ –∏ –æ—Ç–¥—ã—Ö–∞'},
        ]
    }
}

def get_main_keyboard():
    keyboard = [
        [
            InlineKeyboardButton("–§—É—Ç–±–æ–ª–∫–∏", callback_data="category_tshirts"),
            InlineKeyboardButton("–ö—É—Ä—Ç–∫–∏", callback_data="category_jackets"),
            InlineKeyboardButton("–®—Ç–∞–Ω—ã", callback_data="category_pants"),
        ],
        [InlineKeyboardButton("–û –º–∞–≥–∞–∑–∏–Ω–µ", callback_data="about")],
    ]
    return InlineKeyboardMarkup(keyboard)

def get_category_keyboard(category):
    keyboard = []
    for i, item in enumerate(PRODUCTS[category]['items']):
        keyboard.append([InlineKeyboardButton(item['name'], callback_data=f"item_{category}_{i}")])
    keyboard.append([InlineKeyboardButton("‚Üê –ù–∞–∑–∞–¥", callback_data="main_menu")])
    return InlineKeyboardMarkup(keyboard)

def start(update: Update, context: CallbackContext):
    keyboard = [[InlineKeyboardButton(
        "–û—Ç–∫—Ä—ã—Ç—å –º–∞–≥–∞–∑–∏–Ω", 
        web_app=WebAppInfo(url=WEBAPP_URL)
    )]]
    
    reply_markup = InlineKeyboardMarkup(keyboard)
    
    update.message.reply_text(
        '–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –Ω–∞—à –º–∞–≥–∞–∑–∏–Ω –æ–¥–µ–∂–¥—ã! üëï\n'
        '–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ, —á—Ç–æ–±—ã –æ—Ç–∫—Ä—ã—Ç—å –∫–∞—Ç–∞–ª–æ–≥:',
        reply_markup=reply_markup
    )

def help_command(update: Update, context: CallbackContext):
    update.message.reply_text(
        '–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:\n'
        '/start - –û—Ç–∫—Ä—ã—Ç—å –º–∞–≥–∞–∑–∏–Ω\n'
        '/help - –ü–æ–∫–∞–∑–∞—Ç—å —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ'
    )

def button_click(update: Update, context: CallbackContext):
    query = update.callback_query
    query.answer()

    if query.data == "main_menu":
        query.edit_message_text(
            text="–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é —Ç–æ–≤–∞—Ä–æ–≤:",
            reply_markup=get_main_keyboard()
        )
    elif query.data == "about":
        query.edit_message_text(
            text="–ù–∞—à –º–∞–≥–∞–∑–∏–Ω –æ–¥–µ–∂–¥—ã –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç —à–∏—Ä–æ–∫–∏–π –≤—ã–±–æ—Ä –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω–æ–π –æ–¥–µ–∂–¥—ã.\n"
                 "–î–ª—è –∑–∞–∫–∞–∑–∞ —Å–≤—è–∂–∏—Ç–µ—Å—å —Å –Ω–∞–º–∏: @your_contact\n\n"
                 "‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é",
            reply_markup=InlineKeyboardMarkup([[InlineKeyboardButton("‚Üê –ù–∞–∑–∞–¥", callback_data="main_menu")]])
        )
    elif query.data.startswith("category_"):
        category = query.data.split("_")[1]
        query.edit_message_text(
            text=f"–ö–∞—Ç–µ–≥–æ—Ä–∏—è: {PRODUCTS[category]['name']}\n–í—ã–±–µ—Ä–∏—Ç–µ —Ç–æ–≤–∞—Ä:",
            reply_markup=get_category_keyboard(category)
        )
    elif query.data.startswith("item_"):
        _, category, item_index = query.data.split("_")
        item = PRODUCTS[category]['items'][int(item_index)]
        query.edit_message_text(
            text=f"üè∑ {item['name']}\n"
                 f"üí∞ –¶–µ–Ω–∞: {item['price']}\n"
                 f"üìù {item['description']}\n\n"
                 "–î–ª—è –∑–∞–∫–∞–∑–∞ —Å–≤—è–∂–∏—Ç–µ—Å—å —Å –Ω–∞–º–∏: @your_contact",
            reply_markup=get_category_keyboard(category)
        )

def web_app_data(update: Update, context: CallbackContext):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö –æ—Ç –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è"""
    data = update.effective_message.web_app_data.data
    try:
        # –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö –æ—Ç –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø–æ–∫—É–ø–∫–∏)
        update.message.reply_text(
            f"–°–ø–∞—Å–∏–±–æ –∑–∞ –∑–∞–∫–∞–∑!\n"
            f"–ú—ã —Å–≤—è–∂–µ–º—Å—è —Å –≤–∞–º–∏ –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è.\n"
            f"–î–∞–Ω–Ω—ã–µ –∑–∞–∫–∞–∑–∞: {data}"
        )
    except Exception as e:
        update.message.reply_text("–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∑–∞–∫–∞–∑–∞.")
        logging.error(f"Error processing web app data: {e}")

def add_product(update: Update, context: CallbackContext):
    if update.effective_user.id != int(os.getenv('ADMIN_ID', '0')):
        update.message.reply_text("–£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞.")
        return

    context.bot.send_message(
        chat_id=update.effective_chat.id,
        text="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞:"
    )

def handle_product_input(update: Update, context: CallbackContext):
    user_id = update.effective_user.id
    if user_id != int(os.getenv('ADMIN_ID', '0')):
        return

    message_text = update.message.text

    if not hasattr(context, 'product_data'):
        context.product_data = {}

    if 'title' not in context.product_data:
        context.product_data['title'] = message_text
        update.message.reply_text("–í–≤–µ–¥–∏—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞:")
    elif 'description' not in context.product_data:
        context.product_data['description'] = message_text
        update.message.reply_text("–í–≤–µ–¥–∏—Ç–µ —Ü–µ–Ω—É —Ç–æ–≤–∞—Ä–∞ (—Ç–æ–ª—å–∫–æ —á–∏—Å–ª–æ):")
    elif 'price' not in context.product_data:
        try:
            price = float(message_text)
            context.product_data['price'] = price
            update.message.reply_text("–û—Ç–ø—Ä–∞–≤—å—Ç–µ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ —Ç–æ–≤–∞—Ä–∞ (–ø–æ –æ–¥–Ω–æ–π). –ü–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤—Å–µ—Ö —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π –Ω–∞–ø–∏—à–∏—Ç–µ '–≥–æ—Ç–æ–≤–æ'")
        except ValueError:
            update.message.reply_text("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Ü–µ–Ω—É (—Ç–æ–ª—å–∫–æ —á–∏—Å–ª–æ):")
    elif 'images' not in context.product_data:
        if message_text.lower() == '–≥–æ—Ç–æ–≤–æ':
            if 'images' not in context.product_data:
                update.message.reply_text("–í—ã –Ω–µ –æ—Ç–ø—Ä–∞–≤–∏–ª–∏ –Ω–∏ –æ–¥–Ω–æ–π —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏. –û—Ç–ø—Ä–∞–≤—å—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É:")
                return

            # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–æ–≤–∞—Ä
            product = context.product_data
            product['id'] = str(len(PRODUCTS['tshirts']['items']) + 1)
            
            PRODUCTS['tshirts']['items'].append(product)
            update.message.reply_text("–¢–æ–≤–∞—Ä —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω!")

            del context.product_data
        else:
            update.message.reply_text("–ù–∞–ø–∏—à–∏—Ç–µ '–≥–æ—Ç–æ–≤–æ', —á—Ç–æ–±—ã –∑–∞–∫–æ–Ω—á–∏—Ç—å –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞.")

def handle_photo(update: Update, context: CallbackContext):
    user_id = update.effective_user.id
    if user_id != int(os.getenv('ADMIN_ID', '0')):
        return

    photo = update.message.photo[-1]  # –ë–µ—Ä–µ–º —Å–∞–º–æ–µ –±–æ–ª—å—à–æ–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ
    file = photo.get_file()
    
    # –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π, –µ—Å–ª–∏ –µ—ë –Ω–µ—Ç
    os.makedirs("webapp/images", exist_ok=True)
    
    # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —É–Ω–∏–∫–∞–ª—å–Ω–æ–µ –∏–º—è —Ñ–∞–π–ª–∞
    photo_id = f"product_{len(PRODUCTS['tshirts']['items']) + 1}_{len(context.product_data.get('images', []))}.jpg"
    file_path = f"webapp/images/{photo_id}"
    
    # –°–∫–∞—á–∏–≤–∞–µ–º —Ñ–∞–π–ª
    file.download(file_path)
    
    # –î–æ–±–∞–≤–ª—è–µ–º –ø—É—Ç—å –∫ —Ñ–∞–π–ª—É –≤ –¥–∞–Ω–Ω—ã–µ –æ —Ç–æ–≤–∞—Ä–µ
    if 'images' not in context.product_data:
        context.product_data['images'] = []
    context.product_data['images'].append(photo_id)
    
    update.message.reply_text(
        f"–§–æ—Ç–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ! –û—Ç–ø—Ä–∞–≤—å—Ç–µ —Å–ª–µ–¥—É—é—â–µ–µ –∏–ª–∏ –Ω–∞–ø–∏—à–∏—Ç–µ '–≥–æ—Ç–æ–≤–æ', –µ—Å–ª–∏ —ç—Ç–æ –ø–æ—Å–ª–µ–¥–Ω–µ–µ —Ñ–æ—Ç–æ."
    )

def main():
    # –°–æ–∑–¥–∞–µ–º —ç–∫–∑–µ–º–ø–ª—è—Ä –±–æ—Ç–∞
    updater = Updater(token=os.getenv('BOT_TOKEN'))
    
    # –ü–æ–ª—É—á–∞–µ–º –¥–∏—Å–ø–µ—Ç—á–µ—Ä
    dp = updater.dispatcher

    # –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
    dp.add_handler(CommandHandler("start", start))
    dp.add_handler(CommandHandler("help", help_command))
    dp.add_handler(CommandHandler("add_product", add_product))
    dp.add_handler(CallbackQueryHandler(button_click))
    
    # –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–∞–Ω–Ω—ã—Ö –æ—Ç –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
    dp.add_handler(MessageHandler(Filters.web_app_data, web_app_data))

    # –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π
    dp.add_handler(MessageHandler(Filters.text & ~Filters.command, handle_product_input))
    dp.add_handler(MessageHandler(Filters.photo, handle_photo))

    # –ó–∞–ø—É—Å–∫–∞–µ–º –±–æ—Ç–∞
    updater.start_polling()
    updater.idle()

if __name__ == '__main__':
    main()
